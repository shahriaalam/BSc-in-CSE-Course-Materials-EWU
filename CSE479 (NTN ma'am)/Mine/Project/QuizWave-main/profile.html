<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>My Profile • QuizWave</title>
    <link rel="icon" type="image/png" href="./image/favicon.png" />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/profile.css" />
    <link rel="stylesheet" href="css/navbar.css"/>
  </head>
  <body>
    <div id="site-header"></div>
    <main class="container">
      <section class="card section reveal">
        <div class="container">
          <h1>My Profile</h1>
          <form id="profileForm" class="mt-3">
            <div
              class="grid"
              style="
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 16px;
              "
            >
              <div><label>Full Name</label><input id="p_name" /></div>
              <div><label>Username</label><input id="p_username" /></div>
              <div>
                <label>Email</label><input id="p_email" type="email" disabled />
              </div>
              <div>
                <label>Phone</label>
                <input id="p_phone" type="tel" placeholder="+880…" />
              </div>
              <div>
                <label>Date of Birth</label>
                <input id="p_dob" type="date" />
              </div>
              <div>
                <label>Institution</label>
                <input id="p_institution" type="text" />
              </div>

              <!-- Device upload only -->
              <div>
                <label>Upload Avatar</label>
                <input id="p_avatar_file" type="file" accept="image/*" />
              </div>
            </div>

            <div id="pMsg" class="mt-2"></div>
            <button class="btn" type="submit">Save changes</button>
            <button id="deleteAccountBtn" class="btn danger" type="button">
              Delete account
            </button>
          </form>
        </div>
      </section>
    </main>
    <footer class="container footer-style">
      © <span id="year"></span> QuizWave
    </footer>

    <!-- 1) Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 2) Create global client -->
    <script src="js/01-supabase-connection.js"></script>
    <!-- 3) Optional utilities and auth (requireLogin lives here) -->
    <script src="js/02-utils.js"></script>
    <script src="js/04-auth.js"></script>
    <!-- 4) Shell (navbar, etc.) -->
    <script src="js/site-shell.js"></script>
    <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

    <!-- 5) Profile updater (runs AFTER client + auth are ready) -->
    <!-- Include this after your form in profile.html -->
    <script>
      (function () {
        const el = (id) => document.getElementById(id);
        const clean = (v) => (v == null ? "" : String(v).trim());
        const setMsg = (t, ok = true) => {
          const m = el("pMsg");
          if (!m) return;
          m.textContent = t;
          m.style.color = ok ? "green" : "red";
        };

        let prof = null;

        async function loadProfile() {
          const {
            data: { session },
            error,
          } = await client.auth.getSession();
          if (error) {
            console.error(error);
            setMsg(error.message, false);
            return;
          }
          if (!session?.user) {
            setMsg("Not logged in.", false);
            return;
          }
          const user = session.user;

          const { data } = await client
            .from("profiles")
            .select("*")
            .eq("id", user.id)
            .maybeSingle();

          prof = data || { id: user.id };

          el("p_name") && (el("p_name").value = clean(prof.name));
          el("p_username") && (el("p_username").value = clean(prof.username));
          el("p_phone") && (el("p_phone").value = clean(prof.phone));
          el("p_dob") && (el("p_dob").value = clean(prof.dob));
          el("p_institution") &&
            (el("p_institution").value = clean(prof.institution));
          // email removed
        }

        function buildPartialPayload() {
          const next = {
            name: clean(el("p_name")?.value),
            username: clean(el("p_username")?.value),
            phone: clean(el("p_phone")?.value),
            dob: clean(el("p_dob")?.value),
            institution: clean(el("p_institution")?.value),
          };
          const payload = {};
          for (const k in next) {
            if (next[k] && next[k] !== clean(prof?.[k] ?? ""))
              payload[k] = next[k];
          }
          return payload;
        }

        async function uploadAvatarIfAny(userId) {
          const input = el("p_avatar_file");
          if (!input || !input.files || !input.files[0]) return null;
          const file = input.files[0];
          const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
          const path = `${userId}/${Date.now()}.${ext}`;
          await client.storage
            .from("avatars")
            .upload(path, file, { upsert: true });
          const { data: pub } = client.storage
            .from("avatars")
            .getPublicUrl(path);
          return pub?.publicUrl || null;
        }

        async function onSubmit(e) {
          e.preventDefault();
          setMsg("Saving…");

          const {
            data: { session },
            error,
          } = await client.auth.getSession();
          if (error) {
            console.error(error);
            setMsg(error.message, false);
            return;
          }
          if (!session?.user) {
            setMsg("Not logged in.", false);
            return;
          }
          const user = session.user;

          try {
            // Avatar upload
            const avatar_url = await uploadAvatarIfAny(user.id);

            // Partial profile update
            const payload = buildPartialPayload();
            if (avatar_url) payload.avatar_url = avatar_url;

            if (Object.keys(payload).length > 0) {
              const { error: updErr } = await client
                .from("profiles")
                .update(payload)
                .eq("id", user.id);
              if (updErr) throw updErr;
              prof = { ...prof, ...payload };
              setMsg("Saved!", true);
            } else {
              setMsg("No changes to save.", true);
            }

            await loadProfile();
          } catch (err) {
            console.error("[profile] save catch:", err);
            setMsg(err.message || "Save failed", false);
          }
        }

        document.addEventListener("DOMContentLoaded", async () => {
          await loadProfile();
          const form = el("profileForm") || document.querySelector("form");
          if (form) form.addEventListener("submit", onSubmit);
        });
      })();
    </script>

    <script>
      (function () {
        async function handleDeleteAccount() {
          if (!confirm("Delete your account? This cannot be undone.")) return;
          const typed = prompt("Type DELETE to confirm:");
          if (typed !== "DELETE") return;

          const REDIRECT_URL = "index.html";
          try {
            const {
              data: { session },
              error,
            } = await client.auth.getSession();
            if (error) throw error;

            const token = session?.access_token;
            if (!token) {
              // no session? just go home
              window.location.replace(REDIRECT_URL);
              return;
            }

            // IMPORTANT: full function URL (hosted projects). Replace <PROJECT_REF>.
            const FUNCTION_URL =
              "https://gltboemycmvblogjqexb.supabase.co/functions/v1/delete-user";

            const resp = await fetch(FUNCTION_URL, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            });

            if (!resp.ok) {
              const txt = await resp.text();
              console.warn("[delete-user] failed:", txt);
              // Helpful alert so you can see the exact cause (usually missing service role key)
              alert("Delete failed: " + txt);
            }
          } catch (e) {
            console.error("[deleteAccount]", e);
          } finally {
            // Always sign out locally and redirect so the user is not stuck
            try {
              await client.auth.signOut();
            } catch {}
            window.location.replace(REDIRECT_URL);
          }
        }

        document.addEventListener("DOMContentLoaded", () => {
          const btn = document.getElementById("deleteAccountBtn");
          if (btn) btn.addEventListener("click", handleDeleteAccount);
        });
      })();
    </script>
  </body>
</html>
